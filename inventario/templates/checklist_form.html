{% extends 'base.html' %}
{% block title %}{{ 'Editar' if modo=='editar' else 'Nuevo' }} Checklist | {{ super() }}{% endblock %}
{% block content %}
<h3>Checklist Operación Diaria - {{ 'Editar' if modo=='editar' else 'Nuevo' }}</h3>
{% if duplicado_info %}
  <div class="alert alert-warning" role="alert">
    Ya existe un checklist para la fecha <strong>{{ duplicado_info.fecha }}</strong>
    creado por <strong>{{ duplicado_info.usuario.username if duplicado_info.usuario else '-' }}</strong>
    a las <strong>{{ duplicado_info.created_at|dt_mx('%Y-%m-%d %H:%M') }}</strong>.
    <a class="alert-link" href="{{ url_for('web.checklist_ver', chk_id=duplicado_info.id) }}" target="_blank">Ver existente</a>.
    Si realmente necesitas otro, marca la casilla para confirmar y guardarlo de todas formas.
  </div>
{% endif %}
<form method="post" novalidate enctype="multipart/form-data">
  {{ form.hidden_tag() }}
  {% if duplicado_info %}
    <input type="hidden" name="force" id="force" value="0">
  {% endif %}
  <div class="row mb-3">
    <div class="col-md-3">{{ form.fecha.label(class='form-label') }} {{ form.fecha(class='form-control') }}</div>
    <div class="col-md-9">{{ form.comentarios.label(class='form-label') }} {{ form.comentarios(class='form-control', rows=2) }}</div>
  </div>
  <div class="table-responsive mb-3">
    <table class="table table-sm table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th style="width:28%">Servicio</th>
          <th style="width:14%">Responsable</th>
          <th style="width:10%">Hora</th>
          <th style="width:10%">Imagen</th>
          <th style="width:8%">Estado</th>
          <th style="width:12%">Operador</th>
          <th>Observación</th>
          <th style="width:12%">Ejecutor</th>
        </tr>
      </thead>
      <tbody>
      {% for sub in form.items %}
        <tr>
          <td class="cell-static">
            <input type="hidden" name="{{ sub.form.servicio.name }}" value="{{ sub.form.servicio.data }}">
            <input type="hidden" name="{{ sub.form._idx.name }}" value="{{ sub.form._idx.data }}">
            <strong>{{ sub.form.servicio.data }}</strong>
          </td>
          <td class="cell-static">
            <input type="hidden" name="{{ sub.form.responsable.name }}" value="{{ sub.form.responsable.data }}">
            <span>{{ sub.form.responsable.data }}</span>
          </td>
          <td class="cell-static">
            <input type="hidden" name="{{ sub.form.hora_objetivo.name }}" value="{{ sub.form.hora_objetivo.data }}">
            <span>{{ sub.form.hora_objetivo.data }}</span>
          </td>
          <td class="text-center" style="white-space:nowrap">
            {% set img = (imagenes_map or {}).get(sub.form.servicio.data) %}
            {% if img %}
              <a href="{{ url_for('static', filename='actividades/' ~ img) }}" target="_blank" class="d-inline-block me-1" title="Ver imagen completa">
                <img src="{{ url_for('static', filename='actividades/' ~ img) }}" alt="img {{ sub.form.servicio.data }}" class="thumb-img" loading="lazy">
              </a>
            {% endif %}
            {{ sub.form.image_file(class='form-control form-control-sm', accept='.png,.jpg,.jpeg,.gif,.webp') }}
          </td>
          <td>{{ sub.form.estado(class='form-select form-select-sm') }}</td>
          <td>{{ sub.form.operador(class='form-control form-control-sm', placeholder='usuario@correo') }}</td>
          <td>{{ sub.form.observacion(class='form-control form-control-sm', rows=1, placeholder='Observación...') }}</td>
          <td>{{ sub.form.ejecutor(class='form-control form-control-sm', placeholder='usuario@correo') }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="text-end">{{ form.submit(class='btn btn-primary', value=('Actualizar' if modo=='editar' else 'Guardar')) }}</div>
</form>
{% if duplicado_info %}
{% block scripts %}
  {{ super() }}
  <script>
    // Si hay duplicado, pedir confirmación explícita
    (function(){
      const form = document.querySelector('form');
      if(!form) return;
      form.addEventListener('submit', function(ev){
        const f = document.getElementById('force');
        if(f && f.value !== '1'){
          const ok = confirm('Ya existe un checklist para esta fecha. ¿Crear otro de todas formas?');
          if(ok){ f.value = '1'; }
          else { ev.preventDefault(); }
        }
      });
    })();
  </script>
{% endblock %}
{% endif %}
{% endblock %}
