{% extends 'base.html' %}
{% block title %}Nuevo Inventario{% endblock %}
{% block content %}
<h2 class="h4 mb-3">Nuevo Registro</h2>
<form method="POST" class="row g-3">
  {{ form.hidden_tag() }}
  <div class="col-sm-6">{{ form.region.label(class='form-label') }} {{ form.region(class='form-control', placeholder='Región') }}</div>
  <div class="col-sm-6">{{ form.distrito.label(class='form-label') }} {{ form.distrito(class='form-control') }}</div>
  <div class="col-sm-6 position-relative">
    {{ form.local.label(class='form-label') }}
    {{ form.local(class='form-control', autocomplete='off', placeholder='Código Local') }}
    <div id="local-suggestions" class="list-group position-absolute w-100" style="z-index:1000; max-height:200px; overflow:auto; display:none;"></div>
  </div>
  <div class="col-sm-6">{{ form.farmacia.label(class='form-label') }} {{ form.farmacia(class='form-control') }}</div>
  <div class="col-sm-6">{{ form.puntos_venta.label(class='form-label') }} {{ form.puntos_venta(class='form-control') }}</div>
  <div class="col-sm-6">{{ form.puntos_falla.label(class='form-label') }} {{ form.puntos_falla(class='form-control') }}</div>
  <hr/>
  <div class="col-6 col-md-4">{{ form.monitor_cliente.label(class='form-label small') }} {{ form.monitor_cliente(class='form-select form-select-sm') }}</div>
  <div class="col-6 col-md-4">{{ form.monitor_asesor.label(class='form-label small') }} {{ form.monitor_asesor(class='form-select form-select-sm') }}</div>
  <div class="col-6 col-md-4">{{ form.teclado.label(class='form-label small') }} {{ form.teclado(class='form-select form-select-sm') }}</div>
  <div class="col-6 col-md-4">{{ form.escaner.label(class='form-label small') }} {{ form.escaner(class='form-select form-select-sm') }}</div>
  <div class="col-6 col-md-4">{{ form.mouse_pcm.label(class='form-label small') }} {{ form.mouse_pcm(class='form-select form-select-sm') }}</div>
  <div class="col-6 col-md-4">{{ form.teclado_pcm.label(class='form-label small') }} {{ form.teclado_pcm(class='form-select form-select-sm') }}</div>
  <div class="col-6 col-md-4">{{ form.ups.label(class='form-label small') }} {{ form.ups(class='form-select form-select-sm') }}</div>
  <div class="col-6 col-md-4">{{ form.red_lenta.label(class='form-label small') }} {{ form.red_lenta(class='form-select form-select-sm') }}</div>
  <div class="col-6 col-md-4">{{ form.pinpad.label(class='form-label small') }} {{ form.pinpad(class='form-select form-select-sm') }}</div>
  <div class="col-12">{{ form.comentarios.label(class='form-label') }} {{ form.comentarios(class='form-control', rows=3) }}</div>
  <div class="col-sm-6">{{ form.estado_reporte.label(class='form-label') }} {{ form.estado_reporte(class='form-select') }}</div>
  <div class="col-sm-6">{{ form.fecha_solucion.label(class='form-label') }} {{ form.fecha_solucion(class='form-control') }}</div>
  <div class="col-12 d-flex gap-2 pt-3">
    <button class="btn btn-primary flex-grow-1" type="submit">Guardar</button>
    <a href="{{ url_for('web.inventario_listar') }}" class="btn btn-secondary">Volver</a>
  </div>
  <script>
    const inputLocal = document.getElementById('{{ form.local.id }}');
    const inputRegion = document.getElementById('{{ form.region.id }}');
    const inputDistrito = document.getElementById('{{ form.distrito.id }}');
    const inputFarmacia = document.getElementById('{{ form.farmacia.id }}');
    const box = document.getElementById('local-suggestions');
    let timer;

    async function searchLocales(q) {
      const resp = await fetch(`/api/locales?q=${encodeURIComponent(q)}`);
      if(!resp.ok) return [];
      return await resp.json();
    }
    function clearSuggestions(){ box.innerHTML=''; box.style.display='none'; }
    function renderSuggestions(items){
      if(!items.length){ clearSuggestions(); return; }
      box.innerHTML = '';
      items.forEach(it => {
        const a = document.createElement('button');
        a.type='button';
        a.className='list-group-item list-group-item-action py-1';
        a.textContent = `${it.local} - ${it.farmacia}`;
        a.addEventListener('click', () => {
          inputLocal.value = it.local;
          inputRegion.value = it.region;
          inputDistrito.value = it.distrito;
          inputFarmacia.value = it.farmacia;
          clearSuggestions();
        });
        box.appendChild(a);
      });
      box.style.display='block';
    }
    inputLocal.addEventListener('input', () => {
      const q = inputLocal.value.trim();
      if(q.length < 2){ clearSuggestions(); return; }
      clearTimeout(timer);
      timer = setTimeout(async () => {
        const data = await searchLocales(q);
        renderSuggestions(data);
      }, 250);
    });
    document.addEventListener('click', (e)=>{ if(!box.contains(e.target) && e.target !== inputLocal){ clearSuggestions(); } });
  </script>
</form>
{% endblock %}
